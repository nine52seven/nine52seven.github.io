var SIM=SIM||{};SIM.SETTINGS={init:function(){this.variables(),this.events(),this.buildSpells(),this.buildBuffs(),this.buildTalents()},variables:function(){this.body=$("body"),this.buffs=this.body.find("article.buffs"),this.fight=this.body.find("article.fight"),this.rotation=this.body.find("article.rotation"),this.talents=this.body.find("article.talents"),this.filter=this.body.find("article.filter"),this.close=this.body.find("section.settings .btn-close"),this.bg=this.body.find("section.sidebar .bg")},events:function(){var t=this;t.close.click(function(t){t.preventDefault(),$(".js-settings").removeClass("active"),$("section.settings").removeClass("active")}),t.buffs.on("click",".icon",function(){let e=$(this).toggleClass("active");e.hasClass("active")&&(e.data("group")&&e.siblings().filter('[data-group="'+e.data("group")+'"]').removeClass("active"),e.data("disable-spell")&&$('.rotation [data-id="'+e.data("disable-spell")+'"]').removeClass("active"));for(let e of buffs)e.active=t.buffs.find('[data-id="'+e.id+'"]').hasClass("active");SIM.UI.updateSession(),SIM.UI.updateSidebar()}),t.talents.on("click",".icon",function(e){let i=t.getTalent($(this));i.c=i.c<i.m?i.c+1:i.m,$(this).attr("data-count",i.c),i.c>=i.m&&$(this).addClass("maxed"),i.enable&&$('.rotation [data-id="'+i.enable+'"]').removeClass("hidden"),$(this).find("a").attr("href","https://classic.wowhead.com/spell="+i.s[0==i.c?0:i.c-1]),SIM.UI.updateSession(),SIM.UI.updateSidebar()}),t.talents.on("contextmenu",".icon",function(e){e.preventDefault();let i=t.getTalent($(this));if(i.c=i.c<1?0:i.c-1,$(this).attr("data-count",i.c),$(this).removeClass("maxed"),0==i.c&&i.enable){$('.rotation [data-id="'+i.enable+'"]').removeClass("active").addClass("hidden");for(let t of spells)t.id==i.enable&&(t.active=!1)}$(this).find("a").attr("href","https://classic.wowhead.com/spell="+i.s[0==i.c?0:i.c-1]),SIM.UI.updateSession(),SIM.UI.updateSidebar()}),t.filter.on("click",".sources li",function(e){if($(this).toggleClass("active"),$(this).hasClass("active")){let e=$(this).data("id");t.filter.find(`.phases [data-sources*="${e}"]`).addClass("active")}SIM.UI.updateSession(),SIM.UI.filterGear()}),t.filter.on("click",".phases li",function(e){$(this).toggleClass("active");let i=$(this).data("sources").split(","),a=$(this).hasClass("active");for(let e of i)a?t.filter.find('.sources [data-id="'+e+'"]').addClass("active"):t.filter.find('.sources [data-id="'+e+'"]').removeClass("active");SIM.UI.updateSession(),SIM.UI.filterGear()}),t.rotation.on("click",".spell",function(t){let e=t.target;if("LI"==e.nodeName||"INPUT"==e.nodeName)return;$(this).toggleClass("active");let i=$(this).data("id");for(let t of spells)t.id==i&&(t.active=$(this).hasClass("active"));SIM.UI.updateSession()}),t.rotation.on("keyup",'input[type="text"]',function(t){let e=$(this).parents(".spell").data("id");for(let t of spells)t.id==e&&(t[$(this).attr("name")]=$(this).val());SIM.UI.updateSession()}),t.fight.on("change",'select[name="race"]',function(e){var i=$(this).val(),a=t.rotation.find('[data-id="20572"]'),n=t.rotation.find('[data-id="26296"]'),s=[];"兽人"==i?a.removeClass("hidden"):(a.addClass("hidden").removeClass("active"),s.push(20572)),"巨魔"==i?n.removeClass("hidden"):(n.addClass("hidden").removeClass("active"),s.push(26296));for(let t of spells)s.includes(t.id)&&(t.active=!1);t.bg.attr("data-race",i),SIM.UI.updateSession(),SIM.UI.updateSidebar()}),t.fight.on("change",'select[name="aqbooks"]',function(t){SIM.UI.updateSession(),SIM.UI.updateSidebar()}),t.fight.on("keyup",'input[type="text"]',function(t){SIM.UI.updateSession(),SIM.UI.updateSidebar()}),t.fight.on("change",'select[name="weaponrng"]',function(t){SIM.UI.updateSession(),SIM.UI.updateSidebar()})},buildSpells:function(){for(let t of spells){let e=115671==t.id?11567:t.id,i=$(`<div data-id="${t.id}" class="spell"><div class="icon">\n            <img src="dist/img/${t.iconname.toLowerCase()}.jpg " alt="${t.name}">\n            <a href="https://classic.wowhead.com/spell=${e}" class="wh-tooltip"></a>\n            </div><ul class="options"></ul></div>`);void 0!==t.timetoend&&i.find(".options").append(`<li>最后 <input type="text" name="timetoend" value="${t.timetoend}" data-numberonly="true" /> 秒使用</li>`),void 0!==t.minrage&&i.find(".options").append(`<li>怒气超过 <input type="text" name="minrage" value="${t.minrage}" data-numberonly="true" /> 使用</li>`),void 0!==t.maxrage&&i.find(".options").append(`<li>怒气低于 <input type="text" name="maxrage" value="${t.maxrage}" data-numberonly="true" /> </li>`),void 0!==t.globals&&i.find(".options").append(`<li>开局使用 <input type="text" name="globals" value="${t.globals}" data-numberonly="true" /> </li>`),void 0!==t.maincd&&i.find(".options").append(`<li>嗜血 CD >= <input type="text" name="maincd" value="${t.maincd}" data-numberonly="true" /> 秒</li>`),void 0!==t.crusaders&&i.find(".options").append(`<li>当触发 <input type="text" name="crusaders" value="${t.crusaders}" data-numberonly="true" /> 十字军</li>`),void 0!==t.haste&&i.find(".options").append(`<li>Attack speed at <input type="text" name="haste" value="${t.haste}" data-numberonly="true" /> %</li>`),void 0!==t.priorityap&&i.find(".options").append(`<li>当攻强>= <input style="width:25px" type="text" name="priorityap" value="${t.priorityap}" data-numberonly="true" /> 优先使用嗜血</li>`),23255==t.id&&i.find(".options").append("<li>包括重伤</li>"),11605==t.id&&i.find(".options").append("<li>猛击宏</li>"),2687==t.id&&i.find(".options").append("<li>怒气低于80,立即使用</li>"),void 0!==t.reaction&&i.find(".options").append(`<li>延迟 <input style="width:25px" type="text" name="reaction" value="${t.reaction}" data-numberonly="true" /> ms</li>`),t.hidden&&i.addClass("hidden"),"兽人"==localStorage.race&&20572==t.id&&i.removeClass("hidden"),"巨魔"==localStorage.race&&26296==t.id&&i.removeClass("hidden"),t.active&&i.addClass("active"),void 0!==t.maincd&&i.find(".options li:first-of-type").append(" or"),void 0!==t.crusaders&&i.find(".options li:first-of-type").append(" or"),11567==t.id&&(i.find(".options").empty(),i.find(".options").append('<li>怒气大于 <input type="text" name="minrage" value="30" data-numberonly="true"> 或 嗜血CD >= <input type="text" name="maincd" value="4" data-numberonly="true"> 秒,加入循环队列</li>'),i.find(".options").append(`<li>怒气低于 <input type="text" name="unqueue" value="${t.unqueue}" data-numberonly="true" /> , 主手攻击时间低于<input type="text" name="unqueuetimer" value="${t.unqueuetimer}" data-numberonly="true" /> ms,取消队列</li>`),i.find(".options").append(`<li>延迟 <input style="width:25px" type="text" name="reaction" value="${t.reaction}" data-numberonly="true" /> 毫秒 </li>`)),115671==t.id&&(i.find(".options").empty(),i.find(".options").before("<label>斩杀阶段 英勇打击:</label>"),i.find(".options").append('<li>怒气大于 <input type="text" name="minrage" value="30" data-numberonly="true"> 加入队列</li>'),i.find(".options").append(`<li>怒气低于 <input type="text" name="unqueue" value="${t.unqueue}" data-numberonly="true" /> , 主手攻击时间低于<input type="text" name="unqueuetimer" value="${t.unqueuetimer}" data-numberonly="true" /> ms,取消队列</li>`),i.find(".options").append(`<li>延迟<input style="width:25px" type="text" name="reaction" value="${t.reaction}" data-numberonly="true" /> 毫秒</li>`)),11585==t.id&&(i.find(".options").empty(),i.find(".options").append(`<li>怒气低于 <input type="text" name="maxrage" value="${t.maxrage}" data-numberonly="true" /> 使用,并且</li>`),i.find(".options").append(`<li>嗜血CD >= <input type="text" name="maincd" value="${t.maincd}" data-numberonly="true" /> 秒</li>`),i.find(".options").append(`<li>延迟 <input style="width:25px" type="text" name="reaction" value="${t.reaction}" data-numberonly="true" /> 毫秒 </li>`)),this.rotation.append(i)}this.rotation.children().eq(3).appendTo(this.rotation),this.rotation.children().eq(19).appendTo(this.rotation)},buildBuffs:function(){for(let t of buffs){let e=t.spellid?"spell":"item",i=t.active?"active":"",a=t.group?`data-group="${t.group}"`:"",n=t.disableSpell?`data-disable-spell="${t.disableSpell}"`:"",s=`<div data-id="${t.id}" class="icon ${i}" ${a} ${n}>\n                            <img src="dist/img/${t.iconname.toLowerCase()}.jpg " alt="${t.name}">\n                            <a href="https://classic.wowhead.com/${e}=${t.id}" class="wh-tooltip"></a>\n                        </div>`;this.buffs.append(s)}},buildTalents:function(){for(let t of talents){let e=$('<table><tr><th colspan="4">'+t.n+"</th></tr></table>");for(let t=0;t<7;t++)e.prepend("<tr><td></td><td></td><td></td><td></td></tr>");for(let i of t.t){let t=$('<div class="icon" data-count="'+i.c+'" data-x="'+i.x+'" data-y="'+i.y+'"></div>');t.html('<img src="dist/img/'+i.iconname.toLowerCase()+'.jpg" alt="'+i.n+'" />'),i.c>=i.m&&t.addClass("maxed"),i.enable&&0==i.c&&this.rotation.find('[data-id="'+i.enable+'"]').addClass("hidden"),i.enable&&i.c>0&&this.rotation.find('[data-id="'+i.enable+'"]').removeClass("hidden"),t.append('<a href="https://classic.wowhead.com/spell='+i.s[0==i.c?0:i.c-1]+'" class="wh-tooltip"></a>'),e.find("tr").eq(i.y).children().eq(i.x).append(t)}this.talents.append(e)}},getTalent:function(t){let e=t.parents("table").index(),i=t.data("x"),a=t.data("y");for(let t of talents[e-1].t)if(t.x==i&&t.y==a)return t}};